{#- get dict of user configurations -#}
{%- set gpg = salt['pillar.get']('tool:gpg', {'users': {}}, merge=True) -%}
{%- set users = {} -%}

{%- set package = salt['grains.filter_by']({
  'MacOS': ['gpg', 'pinentry-mac'],
  'default': ['gpg']
  }, 'os_family') -%}

{#- placeholder for future improvements -#}
{%- set pinentry_sane = gpg.get('pinentry_sane_path', salt['grains.filter_by']({
  'default': '/usr/local/bin/pinentry-sane',
  }, 'os_family')) -%}

{%- do gpg.update({'package': package}) -%}

{#- rejectattr filter does not fit with mapping. need to filter out users before merging default values -#}
{%- for tool_user, tool_user_conf in salt['pillar.get']('tool:users', {}).items() -%}
{#- by default, install tool if it was targeted. explicitly deny for a specific user to override -#}
  {%- if tool_user_conf.get('gpg', True) -%}
    {%- do users.update({tool_user: tool_user_conf}) -%}
  {%- endif -%}
{%- endfor -%}

{%- do salt['defaults.merge'](users, gpg.get('users', {})) -%}

{#- update all user configuration for gpg with its defaults -#}
{%- do salt['defaults.update'](users, {'gpg': gpg.get('defaults', {})}) -%}

{#- embed user information that will be reused (home, primary group, shell, paths) -#}
{%- for user in users.keys() -%}
  {%- do users[user].update({'_gpg': {}}) -%}
  {%- do users[user].update({'name': user}) -%}
  {%- set user_info = salt['user.info'](user) -%}
  {%- load_yaml as user_info -%}
group: {{ salt['user.primary_group'](user) }}
home: {{ user_info.home }}
shell: {{ user_info.shell.split('/')[-1] }}
  {%- endload -%}
  {%- do users[user].update(salt['defaults.merge'](user_info, users[user], in_place=False)) -%}

  {%- if users[user].xdg | default('True') -%}
    {#- cannot use environ.get because it only has access to current env, not a specific user's -#}
    {%- load_yaml as xdg -%}
cache: {{ salt['cmd.run']('[ -n "$XDG_CACHE_HOME" ] && echo "${XDG_CACHE_HOME}" || echo "${HOME}/.cache"', runas=user) }}
config: {{ salt['cmd.run']('[ -n "$XDG_CONFIG_HOME" ] && echo "${XDG_CONFIG_HOME}" || echo "${HOME}/.config"', runas=user) }}
data: {{ salt['cmd.run']('[ -n "$XDG_DATA_HOME" ] && echo "${XDG_DATA_HOME}" || echo "${HOME}/.local/share"', runas=user) }}
state: {{ salt['cmd.run']('[ -n "$XDG_STATE_HOME" ] && echo "${XDG_STATE_HOME}" || echo "${HOME}/.local/state"', runas=user) }}
    {%- endload -%}
    {%- do users[user].update({'xdg': xdg}) -%}
    {%- do users[user]['_gpg'].update({'confdir': xdg.data ~ '/gnupg'}) -%}
  {%- else -%}
    {%- do users[user]['_gpg'].update({'confdir': users[user].home ~ '/.gnupg'}) -%}
  {%- endif -%}

  {#- decisions necessary to autoconfigure sane pinentry -#}
  {%- if gpg.get('pinentry_sane') and users[user].gpg.get('pinentry_sane') -%}
    {%- do gpg.update({'_pinentry_sane': pinentry_sane}) %}
    {%- if users[user].gpg.get('agent', {}).get('config') %}
      {#- only update agent config if it is managed by this state -#}
      {%- do users[user].gpg.agent.config.update({'pinentry-program': pinentry_sane}) %}
    {%- else %}
      {#- else just manage line in state (do not overwrite rest) -#}
      {%- do users[user]._gpg.update({'update_pinentry': pinentry_sane}) -%}
    {%- endif %}
  {%- endif %}
{%- endfor -%}

{%- do gpg.update({ 'users': users.values() | list}) -%}
